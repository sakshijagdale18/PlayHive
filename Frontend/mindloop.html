<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mind Loop ‚Äî Play Hive</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet" />
<style>
:root {
  --bg1: #0b0b0f;
  --bg2: #14141c;
  --accent: #ffd54f;
  --accent2: #ffa726;
  --neon: #fff59d;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Poppins', sans-serif;
  background: radial-gradient(circle at top left, #33260022, transparent 60%),
              radial-gradient(circle at bottom right, #ffcc3344, transparent 70%),
              linear-gradient(180deg, var(--bg1), var(--bg2));
  color: #fffbea;
  overflow-x: hidden;
  overflow-y: auto;
}

/* Layers */
canvas#meshCanvas { position: fixed; inset: 0; z-index: -2; }
.particle-layer { position: fixed; inset: 0; pointer-events: none; z-index: -1; }
canvas#confetti { position: fixed; inset: 0; pointer-events: none; z-index: 6; }

.nav {
  position: fixed;
  top: 10px; left: 50%;
  transform: translateX(-50%);
  width: 92%; max-width: 1200px;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 14px;
  padding: 10px 18px;
  backdrop-filter: blur(14px);
  display: flex; justify-content: space-between; align-items: center;
  z-index: 10;
}
.logo { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  box-shadow: 0 0 20px rgba(255,204,51,0.5); animation: floatLogo 3s ease-in-out infinite alternate; }
@keyframes floatLogo { from { transform: translateY(0); } to { transform: translateY(-4px); } }
.title { font-weight: 700; font-size: 1.2rem;
  background: linear-gradient(90deg, var(--accent), var(--accent2), var(--neon));
  -webkit-background-clip: text; color: transparent; }
.nav-links a { text-decoration: none; color: #fffbea; margin-left: 16px; transition: 0.3s; }
.nav-links a:hover { color: var(--accent); text-shadow: 0 0 12px rgba(255,204,51,0.6); }

.wrap { width: 100%; min-height: 100vh; display: flex; justify-content: center; padding-top: 100px; }
.panel { display: grid; grid-template-columns: 1fr 400px; gap: 40px; align-items: flex-start; }
@media(max-width:980px){ .panel{grid-template-columns:1fr;padding:0 20px;} .right{order:-1;} }

.game-card {
  background: rgba(255,255,255,0.05);
  border-radius: 20px;
  padding: 32px;
  border: 1px solid rgba(255,255,255,0.08);
  backdrop-filter: blur(20px);
  box-shadow: 0 14px 40px rgba(255,200,60,0.1);
  text-align: center;
  max-width: 450px;
  animation: floatCard 6s ease-in-out infinite alternate;
}
@keyframes floatCard { from { transform: translateY(0); } to { transform: translateY(10px); } }

h1#gameTitle { color: var(--accent); text-shadow: 0 0 20px rgba(255,204,51,0.6); animation: glowPulse 2s infinite alternate; }
@keyframes glowPulse { from { text-shadow: 0 0 10px rgba(255,204,51,0.3); } to { text-shadow: 0 0 30px rgba(255,204,51,0.8); } }

.sub { color: #fff9c4; margin-top: 5px; font-size: 0.95rem; opacity: 0.9; }

.board { margin-top: 18px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; justify-items: center; }
.hex { width: 95px; height: 110px; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
  clip-path: polygon(50% 0%,92% 25%,92% 75%,50% 100%,8% 75%,8% 25%);
  border: 1px solid rgba(255,255,255,0.05);
  display: flex; align-items: center; justify-content: center;
  transition: 0.2s ease; cursor: pointer; position: relative; }
.hex .inner { width: 80%; height: 80%; border-radius: 14px;
  background: linear-gradient(180deg, var(--accent), var(--accent2)); opacity: 0.35;
  transition: opacity 0.3s ease, transform 0.3s; }
.hex:hover .inner { transform: scale(1.05); opacity: 0.55; }
.hex.glow .inner { opacity: 1; box-shadow: 0 0 30px var(--accent); }

#status { margin-top: 12px; font-weight: 600; color: var(--accent2); font-size: 1.1rem; }
#scoreDisplay { margin-top: 8px; font-weight: 600; color: var(--neon); font-size: 1.2rem; text-shadow: 0 0 15px rgba(255,255,150,0.6); }

.play-btn { margin-top: 24px; padding: 12px 28px; border: none; border-radius: 10px;
  font-weight: 600; font-size: 1rem; color: #1a1400;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  box-shadow: 0 0 20px rgba(255,200,80,0.3);
  cursor: pointer; transition: 0.25s ease; }
.play-btn:hover { transform: scale(1.07); box-shadow: 0 0 35px rgba(255,204,51,0.6); }

.right .card {
  background: rgba(255,255,255,0.04);
  border-radius: 16px; padding: 24px;
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 10px 40px rgba(255,220,100,0.08);
  backdrop-filter: blur(14px);
  animation: floatCard 5s ease-in-out infinite alternate;
}
.right .card h3 { color: var(--accent); text-align: center; font-size: 1.3rem; }
.right .card ol { color: #fffbea; line-height: 1.8; font-size: 0.95rem; padding-left: 20px; }
.right .card ol li:hover { color: var(--accent2); transform: translateX(6px); transition: 0.2s; }

.leaderboard {
  margin-top: 25px;
  background: rgba(255,255,255,0.05);
  border-radius: 16px;
  padding: 18px;
  border: 1px solid rgba(255,255,255,0.1);
}
.leaderboard h3 {
  text-align: center;
  color: var(--accent);
  margin-bottom: 10px;
}
.leaderboard table {
  width: 100%;
  border-collapse: collapse;
  color: #fffbea;
  text-align: center;
}
.leaderboard th, .leaderboard td {
  padding: 6px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.leaderboard tr:hover { color: var(--accent2); }

/* User Info Modal */
.user-modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.8);
  backdrop-filter: blur(5px);
  z-index: 100;
  justify-content: center;
  align-items: center;
}
.modal-content {
  background: rgba(255,255,255,0.1);
  border-radius: 20px;
  padding: 30px;
  border: 1px solid rgba(255,255,255,0.2);
  backdrop-filter: blur(20px);
  max-width: 400px;
  width: 90%;
  text-align: center;
}
.modal-content h3 {
  color: var(--accent);
  margin-bottom: 20px;
}
.email-input {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.1);
  color: white;
  font-size: 1rem;
  margin-bottom: 15px;
}
.email-input::placeholder {
  color: rgba(255,255,255,0.6);
}
.modal-btn {
  padding: 12px 24px;
  border: none;
  border-radius: 10px;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  color: #1a1400;
  font-weight: 600;
  cursor: pointer;
  transition: 0.3s;
}
.modal-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 0 20px rgba(255,204,51,0.5);
}
</style>
</head>
<body>

<canvas id="meshCanvas"></canvas>
<div class="particle-layer" id="particles"></div>
<canvas id="confetti"></canvas>

<!-- User Email Modal -->
<div class="user-modal" id="userModal">
  <div class="modal-content">
    <h3>üéÆ Enter Your Email</h3>
    <p style="color: #fffbea; margin-bottom: 20px;">To save your score and track your progress, please enter your email:</p>
    <input type="email" class="email-input" id="userEmail" placeholder="your.email@example.com">
    <button class="modal-btn" onclick="saveUserEmail()">Start Playing</button>
  </div>
</div>

<nav class="nav">
  <div class="logo">
    <svg viewBox="0 0 24 24" fill="white"><path d="M12 2 L16 6 L12 10 L8 6 Z"/><circle cx="12" cy="14" r="4"/></svg>
  </div>
  <div class="title">Play Hive</div>
  <div class="nav-links">
    <a href="index.html">Home</a>
    <a href="games.html">Games</a>
    <a href="mindlooprulebook.html">How it works</a>
    <a href="">Leaderboard</a>
  </div>
</nav>

<div class="wrap">
  <div class="panel">
    <section class="game-card">
      <h1 id="gameTitle">üß† Mind Loop</h1>
      <div class="sub">Test your focus. Match the rhythm. Rule the loop.</div>
      <div class="board" id="board"></div>
      <button class="play-btn" id="playBtn">‚ñ∂ Play</button>
      <div id="status"></div>
      <div id="scoreDisplay"></div>
    </section>

    <aside class="right">
      <div class="card">
        <h3>How to Play</h3>
        <ol>
          <li>Hit "Play" to see the glowing sequence.</li>
          <li>Repeat the pattern by tapping the tiles.</li>
          <li>Each round adds one more glow. Stay sharp!</li>
          <li>Miss the sequence? Game over.</li>
        </ol>
      </div>
      <div class="leaderboard" id="leaderboardSec">
        <h3>üèÜ Leaderboard</h3>
        <table>
          <thead>
            <tr><th>Rank</th><th>Player</th><th>Score</th><th>Time</th></tr>
          </thead>
          <tbody id="leaderboardBody"><tr><td colspan="4">Loading...</td></tr></tbody>
        </table>
      </div>
    </aside>
  </div>
</div>

<script>
/* === BACKGROUND GRID === */
const canvas=document.getElementById('meshCanvas'),ctx=canvas.getContext('2d');
function resize(){canvas.width=innerWidth;canvas.height=innerHeight;}
resize();window.addEventListener('resize',resize);
let t=0;
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let i=0;i<8;i++){
    ctx.beginPath();
    const r=220+90*i+Math.sin(t*0.3+i)*8;
    ctx.strokeStyle=`rgba(255,204,51,${0.015+i*0.005})`;
    ctx.arc(canvas.width/2,canvas.height/2,r,0,Math.PI*2);
    ctx.stroke();
  }
  t+=0.5;requestAnimationFrame(draw);
}
draw();

/* === PARTICLES === */
const pLayer=document.getElementById('particles');
for(let i=0;i<30;i++){
  const p=document.createElement('div');p.className='particle';
  p.style.left=Math.random()*100+'%';p.style.top=Math.random()*100+'%';
  p.style.animationDelay=Math.random()*5+'s';
  pLayer.appendChild(p);
}

/* === GAME === */
const board=document.getElementById('board');
const playBtn=document.getElementById('playBtn');
const statusText=document.getElementById('status');
const scoreDisplay=document.getElementById('scoreDisplay');
let sequence=[],userSequence=[],round=0,canClick=false,speed=700,score=0,streak=0;
let userEmail = localStorage.getItem('userEmail');

function createTiles(){
  for(let i=0;i<9;i++){
    const hex=document.createElement('div');
    hex.className='hex';
    const inner=document.createElement('div');
    inner.className='inner';
    hex.appendChild(inner);
    hex.addEventListener('click',()=>handleClick(i));
    board.appendChild(hex);
  }
}
createTiles();

function glowTile(i){
  const hex=board.children[i];
  hex.classList.add('glow');
  setTimeout(()=>hex.classList.remove('glow'),300);
}
function playSequence(){
  canClick=false;userSequence=[];
  let i=0;const interval=setInterval(()=>{
    glowTile(sequence[i]);i++;
    if(i>=sequence.length){clearInterval(interval);setTimeout(()=>canClick=true,300);}
  },speed);
}
function nextRound(){
  round++;
  statusText.innerHTML=`Round ${round}`;
  scoreDisplay.innerHTML=`üèÜ Score: ${score}`;
  sequence.push(Math.floor(Math.random()*9));
  speed=Math.max(250,700-round*15);
  setTimeout(playSequence,800);
}
function calculateScore(){
  let base=1;
  let difficultyBonus=Math.floor((700-speed)/50);
  let streakBonus=Math.min(streak*2,15);
  let roundBonus=Math.floor(round*1.5);
  score+=base+difficultyBonus+roundBonus+streakBonus;
}
function handleClick(i){
  if(!canClick)return;
  glowTile(i);
  userSequence.push(i);
  const idx=userSequence.length-1;
  if(userSequence[idx]!==sequence[idx]){
    statusText.innerHTML=`‚ùå Oops! You lost.`;
    scoreDisplay.innerHTML=`Final Score: ${score}`;
    confettiBurst(false);
    saveScore(score);
    resetGame();
    return;
  }
  if(userSequence.length===sequence.length){
    streak++;
    calculateScore();
    scoreDisplay.innerHTML=`üèÜ Score: ${score}`;
    statusText.innerHTML=`‚úÖ Nice!`;
    confettiBurst(true);
    setTimeout(nextRound,1000);
  }
}
function resetGame(){
  canClick=false;
  sequence=[];userSequence=[];
  speed=700;round=0;streak=0;score=0;
  scoreDisplay.innerHTML=`üèÜ Score: 0`;
}

// Check if user email exists before starting game
playBtn.addEventListener('click',()=>{
  if (!userEmail) {
    document.getElementById('userModal').style.display = 'flex';
    return;
  }
  startGame();
});

function startGame() {
  resetGame();
  statusText.innerHTML="Get ready...";
  nextRound();
}

/* === USER EMAIL MANAGEMENT === */
function saveUserEmail() {
  const emailInput = document.getElementById('userEmail');
  const email = emailInput.value.trim();
  
  if (!email) {
    alert('Please enter your email to continue.');
    return;
  }
  
  if (!validateEmail(email)) {
    alert('Please enter a valid email address.');
    return;
  }
  
  userEmail = email;
  localStorage.setItem('userEmail', email);
  document.getElementById('userModal').style.display = 'none';
  startGame();
}

function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

// Show modal if no email on page load
window.addEventListener('load', () => {
  if (!userEmail) {
    document.getElementById('userModal').style.display = 'flex';
  }
  loadLeaderboard();
});

/* === CONFETTI === */
const confettiCanvas=document.getElementById('confetti'),cCtx=confettiCanvas.getContext('2d');
function resizeConfetti(){confettiCanvas.width=innerWidth;confettiCanvas.height=innerHeight;}
resizeConfetti();window.addEventListener('resize',resizeConfetti);
let confettis=[];
function confettiBurst(success){
  for(let i=0;i<100;i++){
    confettis.push({
      x:innerWidth/2,y:innerHeight/2,
      color:success?`hsl(${Math.random()*40+45},100%,60%)`:`hsl(10,100%,60%)`,
      r:Math.random()*4+2,dx:(Math.random()-0.5)*6,dy:(Math.random()-0.5)*6,life:100
    });
  }
}
function updateConfetti(){
  cCtx.clearRect(0,0,innerWidth,innerHeight);
  confettis.forEach(p=>{p.x+=p.dx;p.y+=p.dy;p.dy+=0.05;p.life--;
    cCtx.beginPath();cCtx.arc(p.x,p.y,p.r,0,2*Math.PI);cCtx.fillStyle=p.color;cCtx.fill();
  });
  confettis=confettis.filter(p=>p.life>0);
  requestAnimationFrame(updateConfetti);
}
updateConfetti();

/* === SAVE SCORE + LEADERBOARD === */
  /* === SAVE SCORE + LEADERBOARD === */
async function saveScore(finalScore){
  if (!userEmail) {
    console.warn("‚ö† No user email found. Score not saved.");
    return;
  }
  
  try{
    // Calculate game statistics based on performance
    const calculatedLevel = Math.max(1, Math.floor(round / 3));
    const calculatedTime = Math.floor(round * 2.5); // Estimate time in seconds
    const calculatedCorrect = round; // Each successful round = 1 correct sequence
    const calculatedTotal = round + 1; // Total attempts (including the failed one)

    const scoreData = {
      email: userEmail,
      score: finalScore,
      level: calculatedLevel,
      timeTaken: calculatedTime,
      correctAnswers: calculatedCorrect,
      totalQuestions: calculatedTotal
    };

    console.log("üì§ Saving score:", scoreData);

    const res = await fetch("http://localhost:8088/api/mindloop/submit-score-by-email-simple", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(scoreData)
    });
    
    const data = await res.json();
    if(res.ok){
      console.log("‚úÖ Score saved successfully:", data);
      await loadLeaderboard(); // Refresh leaderboard after saving
    } else {
      console.error("‚ùå Save failed:", data);
    }
  } catch(err) {
    console.error("‚ùå Error saving score:", err);
  }
}

async function loadLeaderboard(){
  try{
    const res=await fetch("http://localhost:8088/api/mindloop/leaderboard");
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    const data=await res.json();
    const tbody=document.getElementById("leaderboardBody");
    tbody.innerHTML="";
    
    if (data && data.length > 0) {
      data.forEach((entry,idx)=>{
        const playedOn = entry.playedOn ? new Date(entry.playedOn).toLocaleDateString() : 'Recent';
        tbody.innerHTML+=`
        <tr>
          <td>${idx+1}</td>
          <td>${entry.username || 'Anonymous'}</td>
          <td>${entry.score}</td>
          <td>${entry.timeTaken || 0}s</td>
        </tr>`;
      });
    } else {
      tbody.innerHTML='<tr><td colspan="4">No scores yet. Be the first!</td></tr>';
    }
  }catch(err){
    console.error("Error loading leaderboard:",err);
    document.getElementById("leaderboardBody").innerHTML='<tr><td colspan="4">Failed to load leaderboard</td></tr>';
  }
}

// Load leaderboard on page load
window.addEventListener('load', loadLeaderboard);
</script>

</body>
</html>